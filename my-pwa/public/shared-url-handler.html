<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Processing Shared URL</title>
    <style>
        #debug-log p { margin: 0.2em 0; } /* Basic styling for log messages */
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            (function() { // IIFE kept for scope isolation
                function logDebug(message) {
                    const logContainer = document.getElementById('debug-log');
                    if (logContainer) {
                        const p = document.createElement('p');
                        if (typeof message === 'object' && message !== null) {
                            try {
                                p.textContent = JSON.stringify(message);
                            } catch (e) {
                                p.textContent = "Error stringifying object for debug log";
                                console.error("Error stringifying object for debug log:", message, e);
                            }
                        } else {
                            p.textContent = String(message);
                        }
                        logContainer.appendChild(p);
                    }
                    console.log(message);
                }

                logDebug('DOM fully loaded and parsed. Script started.');

                if (typeof localforage === 'undefined') {
                    logDebug('ERROR: localforage is not loaded! Check CDN link or network.');
                    setTimeout(function() {
                        logDebug('Executing redirect now (localforage not loaded).');
                        window.location.replace('./index.html');
                    }, 5000);
                    return;
                }

                logDebug('Configuring localforage...');
                try {
                    localforage.config({
                        name: 'UrlViewerPWA',
                        storeName: 'urls',
                        description: 'Storage for URL data (from share handler)',
                    });
                    logDebug('localforage configured successfully.');
                } catch (e) {
                    logDebug('Error configuring localforage: ' + e.toString());
                }

                const params = new URLSearchParams(window.location.search);
                logDebug('Raw URL Search Params: ' + params.toString());

                let sharedUrl = params.get('url');
                const sharedTitle = params.get('title') || '';
                const sharedText = params.get('text') || '';
                let urlSource = 'url_param';

                logDebug('Initial parameters:');
                logDebug('  URL from "url" param: ' + (sharedUrl === null ? 'null' : sharedUrl));
                logDebug('  Title from "title" param: ' + sharedTitle);
                logDebug('  Text from "text" param: ' + sharedText);

                function isValidHttpUrl(string) {
                    if (!string) return false; // Ensure string is not null or empty
                    let url;
                    try {
                        url = new URL(string);
                    } catch (_) {
                        return false;
                    }
                    return url.protocol === "http:" || url.protocol === "https:";
                }

                if (!sharedUrl || !isValidHttpUrl(sharedUrl)) {
                    logDebug('URL from "url" param is missing or invalid: "' + sharedUrl + '"');
                    if (sharedText) {
                        const urlRegex = /(https?:\/\/[^\s]+)/;
                        const foundInText = sharedText.match(urlRegex);
                        if (foundInText && foundInText[0]) {
                            logDebug('Found a potential URL in "text" param: ' + foundInText[0]);
                            if (isValidHttpUrl(foundInText[0])) {
                                sharedUrl = foundInText[0];
                                urlSource = 'text_param';
                                logDebug('Using URL from "text" param: ' + sharedUrl);
                            } else {
                                logDebug('Potential URL in "text" param is invalid: ' + foundInText[0]);
                            }
                        } else {
                            logDebug('No URL found in "text" param.');
                        }
                    } else {
                        logDebug('"text" param is also empty or null.');
                    }
                } else {
                    logDebug('Using valid URL from "url" param: ' + sharedUrl);
                }

                if (sharedUrl && isValidHttpUrl(sharedUrl)) {
                    logDebug('Final determined URL to process: ' + sharedUrl + ' (Source: ' + urlSource + ')');
                } else {
                    logDebug('No valid URL found in either "url" or "text" parameters. Current sharedUrl value: "' + sharedUrl + '"');
                }

                function scheduleRedirect(timeout = 30000, reason = "") {
                    const reasonMsg = reason ? ` (${reason})` : "";
                    logDebug(`Redirecting to ./index.html in ${timeout/1000} seconds${reasonMsg}...`);
                    setTimeout(function() {
                        logDebug(`Executing redirect now${reasonMsg}.`);
                        window.location.replace('./index.html');
                    }, timeout);
                }

                if (sharedUrl && isValidHttpUrl(sharedUrl)) { // Check validity again before processing
                    logDebug('Proceeding to process valid shared URL with localforage: ' + sharedUrl);

                    localforage.getItem('appUrls').then(function(storedUrls) {
                        logDebug('Data retrieved from localforage for appUrls: ' + JSON.stringify(storedUrls));
                        let urls = [];
                        if (storedUrls && Array.isArray(storedUrls)) {
                            urls = storedUrls;
                        } else {
                            logDebug('No valid array found for appUrls in localforage, starting with empty array.');
                        }
                        logDebug('Current URLs from localforage (before modification): ' + JSON.stringify(urls));

                        const newUrlEntry = {
                            url: sharedUrl, // This is the validated and possibly extracted URL
                            title: sharedTitle || sharedUrl,
                            text: sharedText, // Original sharedText is preserved for context if needed
                            status: 'unloaded'
                        };
                        logDebug('New URL entry to add: ' + JSON.stringify(newUrlEntry));

                        const existingIndex = urls.findIndex(item => item.url === newUrlEntry.url);
                        if (existingIndex > -1) {
                            logDebug('URL already exists at index ' + existingIndex + '. Removing old entry to move to top.');
                            urls.splice(existingIndex, 1);
                        }
                        urls.unshift(newUrlEntry);
                        logDebug('URLs after adding new entry (before saving to localforage): ' + JSON.stringify(urls));

                        return localforage.setItem('appUrls', urls);
                    }).then(function(savedValue) {
                        logDebug('Successfully saved updated appUrls to localforage. Saved value (sample): ' + JSON.stringify(savedValue).substring(0, 200) + '...');
                        scheduleRedirect(30000, "save successful");
                    }).catch(function(err) {
                        logDebug('Error with localforage operations (getItem or setItem): ' + err.toString());
                        console.error('Localforage error:', err);
                        scheduleRedirect(30000, "storage error");
                    });

                } else {
                    logDebug('No valid shared URL to process after checking both "url" and "text" params.');
                    scheduleRedirect(30000, "no valid sharedUrl found");
                }
            })();
        });
    </script>
</head>
<body>
    <div id="debug-log" style="padding: 10px; border: 1px solid #ccc; margin-bottom: 10px; background-color: #f9f9f9; font-family: monospace; white-space: pre-wrap; max-height: 400px; overflow-y: auto;">
        <h3>Debug Log:</h3>
    </div>
    <p>Processing shared content... You will be redirected shortly.</p>
    <p>If you are not redirected automatically, <a href="./index.html">click here to go to the main application</a>.</p>
</body>
</html>
