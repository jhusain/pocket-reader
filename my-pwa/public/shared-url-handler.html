<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Processing Shared URL</title>
    <style>
        #debug-log p { margin: 0.2em 0; } /* Basic styling for log messages */
    </style>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            (function() { // IIFE kept for scope isolation
                function logDebug(message) {
                    const logContainer = document.getElementById('debug-log');
                    if (logContainer) {
                        const p = document.createElement('p');
                        if (typeof message === 'object' && message !== null) {
                            try {
                                p.textContent = JSON.stringify(message);
                            } catch (e) {
                                p.textContent = "Error stringifying object for debug log";
                                console.error("Error stringifying object for debug log:", message, e);
                            }
                        } else {
                            p.textContent = String(message);
                        }
                        logContainer.appendChild(p);
                    }
                    console.log(message);
                }

                logDebug('DOM fully loaded and parsed. Script started.');

                // Function to safely parse JSON from localStorage
                function getUrlsFromLocalStorage() {
                    logDebug('Attempting to get appUrls from localStorage.');
                    const storedUrlsRaw = localStorage.getItem('appUrls');
                    logDebug('Raw appUrls from localStorage: ' + (storedUrlsRaw === null ? 'null' : storedUrlsRaw));
                    let parsedUrls = [];
                    if (storedUrlsRaw) {
                        try {
                            parsedUrls = JSON.parse(storedUrlsRaw);
                            if (!Array.isArray(parsedUrls)) {
                               logDebug('Parsed appUrls is not an array, defaulting to empty array.');
                               parsedUrls = [];
                            }
                        } catch (e) {
                            console.error('Error parsing appUrls from localStorage:', e);
                            logDebug('Error parsing appUrls: ' + e.toString());
                            parsedUrls = [];
                        }
                    }
                    logDebug('Parsed URLs from localStorage (from getUrlsFromLocalStorage): ' + JSON.stringify(parsedUrls));
                    return parsedUrls;
                }

                const params = new URLSearchParams(window.location.search);
                logDebug('URL Search Params: ' + params.toString());

                const sharedUrl = params.get('url');
                const sharedTitle = params.get('title') || '';
                const sharedText = params.get('text') || '';

                logDebug('Shared URL: ' + (sharedUrl === null ? 'null' : sharedUrl));
                logDebug('Shared Title: ' + sharedTitle);
                logDebug('Shared Text: ' + sharedText);

                if (sharedUrl) {
                    logDebug('sharedUrl is present. Proceeding to process.');
                    const urls = getUrlsFromLocalStorage();
                    logDebug('Current URLs from storage (before modification, inside if(sharedUrl)): ' + JSON.stringify(urls));

                    const newUrlEntry = {
                        url: sharedUrl,
                        title: sharedTitle || sharedUrl,
                        text: sharedText,
                        status: 'unloaded'
                    };
                    logDebug('New URL entry to add: ' + JSON.stringify(newUrlEntry));

                    const existingIndex = urls.findIndex(item => item.url === sharedUrl);
                    if (existingIndex > -1) {
                        logDebug('URL already exists at index ' + existingIndex + '. Removing old entry to move to top.');
                        urls.splice(existingIndex, 1);
                    }
                    urls.unshift(newUrlEntry);
                    logDebug('URLs after adding new entry (before saving): ' + JSON.stringify(urls));

                    try {
                        logDebug('Attempting to save updated appUrls to localStorage.');
                        localStorage.setItem('appUrls', JSON.stringify(urls));
                        logDebug('Successfully saved updated appUrls.');
                    } catch (e) {
                        console.error('Error saving appUrls to localStorage:', e);
                        logDebug('Error saving appUrls: ' + e.toString());
                    }
                } else {
                    logDebug('No sharedUrl parameter found in the URL.');
                }

                logDebug('Redirecting to ./index.html in 30 seconds...');
                setTimeout(function() {
                    logDebug('Executing redirect now.');
                    window.location.replace('./index.html');
                }, 30000); // 30 seconds
            })(); // End of IIFE
        }); // End of DOMContentLoaded listener
    </script>
</head>
<body>
    <div id="debug-log" style="padding: 10px; border: 1px solid #ccc; margin-bottom: 10px; background-color: #f9f9f9; font-family: monospace; white-space: pre-wrap; max-height: 400px; overflow-y: auto;">
        <h3>Debug Log:</h3>
    </div>
    <p>Processing shared content... You will be redirected shortly.</p>
    <p>If you are not redirected automatically after 30 seconds, <a href="./index.html">click here to go to the main application</a>.</p>
</body>
</html>
