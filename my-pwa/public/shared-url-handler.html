<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Processing Shared URL</title>
    <style>
        #debug-log p { margin: 0.2em 0; } /* Basic styling for log messages */
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            (function() { // IIFE kept for scope isolation
                function logDebug(message) {
                    const logContainer = document.getElementById('debug-log');
                    if (logContainer) {
                        const p = document.createElement('p');
                        if (typeof message === 'object' && message !== null) {
                            try {
                                p.textContent = JSON.stringify(message);
                            } catch (e) {
                                p.textContent = "Error stringifying object for debug log";
                                console.error("Error stringifying object for debug log:", message, e);
                            }
                        } else {
                            p.textContent = String(message);
                        }
                        logContainer.appendChild(p);
                    }
                    console.log(message);
                }

                logDebug('DOM fully loaded and parsed. Script started.');

                if (typeof localforage === 'undefined') {
                    logDebug('ERROR: localforage is not loaded! Check CDN link or network.');
                    // Attempt to redirect anyway, or show a more prominent error.
                    setTimeout(function() {
                        logDebug('Executing redirect now (localforage not loaded).');
                        window.location.replace('./index.html');
                    }, 5000); // Shorter delay if core functionality is missing
                    return; // Stop further execution
                }

                logDebug('Configuring localforage...');
                try {
                    localforage.config({
                        name: 'UrlViewerPWA',
                        storeName: 'urls', // This MUST match the storeName in the main app
                        description: 'Storage for URL data (from share handler)',
                    });
                    logDebug('localforage configured successfully.');
                } catch (e) {
                    logDebug('Error configuring localforage: ' + e.toString());
                    // Proceeding, but localforage operations might fail or use defaults
                }

                const params = new URLSearchParams(window.location.search);
                logDebug('URL Search Params: ' + params.toString());

                const sharedUrl = params.get('url');
                const sharedTitle = params.get('title') || '';
                const sharedText = params.get('text') || '';

                logDebug('Shared URL: ' + (sharedUrl === null ? 'null' : sharedUrl));
                logDebug('Shared Title: ' + sharedTitle);
                logDebug('Shared Text: ' + sharedText);

                // Define redirect function to avoid repetition
                function scheduleRedirect(timeout = 30000, reason = "") {
                    const reasonMsg = reason ? ` (${reason})` : "";
                    logDebug(`Redirecting to ./index.html in ${timeout/1000} seconds${reasonMsg}...`);
                    setTimeout(function() {
                        logDebug(`Executing redirect now${reasonMsg}.`);
                        window.location.replace('./index.html');
                    }, timeout);
                }

                if (sharedUrl) {
                    logDebug('sharedUrl is present. Proceeding to process with localforage.');

                    localforage.getItem('appUrls').then(function(storedUrls) {
                        logDebug('Data retrieved from localforage for appUrls: ' + JSON.stringify(storedUrls));
                        let urls = [];
                        if (storedUrls && Array.isArray(storedUrls)) {
                            urls = storedUrls;
                        } else {
                            logDebug('No valid array found for appUrls in localforage, starting with empty array.');
                        }
                        logDebug('Current URLs from localforage (before modification): ' + JSON.stringify(urls));

                        const newUrlEntry = {
                            url: sharedUrl,
                            title: sharedTitle || sharedUrl,
                            text: sharedText,
                            status: 'unloaded'
                        };
                        logDebug('New URL entry to add: ' + JSON.stringify(newUrlEntry));

                        const existingIndex = urls.findIndex(item => item.url === sharedUrl);
                        if (existingIndex > -1) {
                            logDebug('URL already exists at index ' + existingIndex + '. Removing old entry to move to top.');
                            urls.splice(existingIndex, 1);
                        }
                        urls.unshift(newUrlEntry);
                        logDebug('URLs after adding new entry (before saving to localforage): ' + JSON.stringify(urls));

                        return localforage.setItem('appUrls', urls); // Return the promise
                    }).then(function(savedValue) {
                        logDebug('Successfully saved updated appUrls to localforage. Saved value (potentially truncated by localforage driver): ' + JSON.stringify(savedValue).substring(0, 200) + '...');
                        scheduleRedirect(30000, "save successful");
                    }).catch(function(err) {
                        logDebug('Error with localforage operations (getItem or setItem): ' + err.toString());
                        console.error('Localforage error:', err);
                        scheduleRedirect(30000, "storage error");
                    });

                } else {
                    logDebug('No sharedUrl parameter found in the URL.');
                    scheduleRedirect(30000, "no sharedUrl");
                }
            })(); // End of IIFE
        }); // End of DOMContentLoaded listener
    </script>
</head>
<body>
    <div id="debug-log" style="padding: 10px; border: 1px solid #ccc; margin-bottom: 10px; background-color: #f9f9f9; font-family: monospace; white-space: pre-wrap; max-height: 400px; overflow-y: auto;">
        <h3>Debug Log:</h3>
    </div>
    <p>Processing shared content... You will be redirected shortly.</p>
    <p>If you are not redirected automatically, <a href="./index.html">click here to go to the main application</a>.</p>
</body>
</html>
